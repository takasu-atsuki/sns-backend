name: sns-ecs-backend-test-deploy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.9]
    steps:
      - uses: actions/checkout@v2
      - name: docker-compose run
        run: |
          docker-compose up --build -d
          sleep 20
      - name: DB migrations
        run: |
          docker ps 
          docker-compose run app python manage.py makemigrations
          docker-compose run app python manage.py migrate
      - name: DB permission
        run: |
          docker exec sns_mysql mysql -uroot -proot -e"GRANT ALL PRIVILEGES ON test_sns.* TO 'user'@'%'"
      - name: test app
        env:
          SECRET_KEY: ${{secrets.SECRET_KEY}}
          AWS_ACCESS_KEYID: ${{secrets.AWS_ACCESS_KEYID}}
          AWS_S3_BACKET_NAME: ${{secrets.AWS_S3_BACKET_NAME}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
        run: |
          docker exec -e SECRET_KEY=$SECRET_KEY -e AWS_ACCESS_KEYID=$AWS_ACCESS_KEYID -e AWS_S3_BACKET_NAME=$AWS_S3_BACKET_NAME -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY python_django python manage.py test
